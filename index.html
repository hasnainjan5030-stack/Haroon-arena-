<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Harvona Study Timer</title>

  <!-- Clash Grotesk from Fontshare -->
  <link rel="stylesheet" href="https://api.fontshare.com/css?f[]=clash-grotesk@400,600,700&display=swap">

  <style>
    :root{
      --bg:#f5fbff;
      --card:#ffffff;
      --accent:#6aa6ff; /* calm blue */
      --terracotta:#D07A5A; /* warm terracotta */
      --plant:#79BFA3; /* soft green */
      --muted:#7b8790;
      --glass: rgba(255,255,255,0.7);
      --radius:18px;
      --font: 'Clash Grotesk', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;font-family:var(--font);background:linear-gradient(180deg,var(--bg) 0%, #eef7ff 100%);-webkit-font-smoothing:antialiased}
    .app{
      max-width:980px;margin:18px auto;padding:18px;
    }

    header{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#7ad1d8);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(30,60,100,0.08);
      position:relative; overflow:hidden;
    }
    .logo svg{transform:translateY(-4px)}
    h1{font-size:20px;margin:0}
    p.lead{color:var(--muted);margin:6px 0 18px;font-size:13px}

    /* Main layout */
    .grid{
      display:grid;grid-template-columns:1fr 360px;gap:16px;
    }
    .card{
      background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 6px 18px rgba(20,30,60,0.06);
    }

    /* Home (left) */
    .start-btn{
      width:100%;padding:18px;border-radius:14px;background:linear-gradient(90deg,var(--accent),#61d1b6);color:white;border:0;font-weight:700;font-size:18px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:12px;
      box-shadow:0 10px 20px rgba(90,150,255,0.12);transition:transform .12s ease;
    }
    .start-btn:active{transform:translateY(2px)}
    .preset-row{display:flex;gap:8px;margin-top:12px}
    .preset{padding:8px 12px;border-radius:12px;background:var(--glass);border:1px dashed rgba(120,160,200,0.12);cursor:pointer;font-weight:600}

    /* Tasks */
    .tasks{margin-top:18px}
    .task-row{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);margin-bottom:10px}
    .task-subject{font-size:15px;font-weight:700}
    .task-time{margin-left:auto;color:var(--muted);font-weight:600}
    .bounce{animation:bounce .6s ease}
    @keyframes bounce{0%{transform:translateY(-6px)}50%{transform:translateY(2px)}100%{transform:translateY(0)}}

    /* Right column: focus & illustration */
    .focus-area{display:flex;flex-direction:column;align-items:center;gap:12px}
    .illustration{width:100%;height:140px;border-radius:12px;background:linear-gradient(180deg, #fff 0%, #f7fcff 100%);display:flex;align-items:center;justify-content:center;overflow:hidden}
    /* "hand-drawn" plant animation */
    .plant{width:120px;height:120px;transform-origin:center bottom;animation:plantGrow 10s linear infinite}
    @keyframes plantGrow{0%{transform:translateY(6px) scale(0.98)}50%{transform:translateY(0) scale(1.02)}100%{transform:translateY(6px) scale(0.98)}}

    /* Timer circle */
    .timer-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;padding:14px}
    .progress-ring{width:220px;height:220px;display:grid;place-items:center;position:relative}
    .time-label{font-size:28px;font-weight:700}
    .locked-badge{position:absolute;top:12px;left:12px;background:linear-gradient(90deg,var(--terracotta),#f7a58c);color:white;padding:6px 10px;border-radius:999px;font-weight:700;box-shadow:0 6px 14px rgba(208,122,90,0.14)}

    /* Overlay & Focus Lock */
    .overlay{position:fixed;inset:0;background:linear-gradient(90deg,rgba(9,18,40,0.55),rgba(9,18,40,0.4));display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter: blur(3px);display:none}
    .overlay.show{display:flex}
    .overlay .box{background:linear-gradient(180deg,#fff,#f8fbff);padding:18px;border-radius:14px;text-align:center;max-width:420px}
    .overlay .title{font-size:20px;font-weight:800}
    .overlay p{color:var(--muted);margin-top:8px}

    /* Confetti (simple) */
    .confetti{pointer-events:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000}

    /* Alarm fullscreen */
    .alarm-screen{position:fixed;inset:0;background:linear-gradient(180deg,#fff3ed,#fff6f2);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:10001}
    .alarm-screen.show{display:flex}
    .alarm-screen h2{font-size:26px;margin:6px 0}
    .alarm-cta{padding:14px 20px;border-radius:12px;background:linear-gradient(90deg,#6ad1b6,#6aa6ff);color:white;font-weight:800;border:0;cursor:pointer;margin-top:12px}

    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}

    /* small screens */
    @media (max-width:880px){
      .grid{grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo" aria-hidden="true">
        <!-- small hand-drawn book + clock svg -->
        <svg width="48" height="48" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="4" y="12" width="40" height="36" rx="6" fill="#FFF" stroke="rgba(0,0,0,0.08)" />
          <path d="M46 18h10v18" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
          <circle cx="46" cy="44" r="8" fill="#fff"/>
        </svg>
      </div>
      <div>
        <h1>Harvona Study Timer</h1>
        <p class="lead">Cozy focus sessions, locked-in mode, and gentle reminders.</p>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
            <div>
              <div style="font-weight:800">Ready to focus?</div>
              <div style="color:var(--muted);font-size:13px">Start a session and lock distractions.</div>
            </div>
            <div style="text-align:right;color:var(--muted);font-weight:700" id="streak">Streak: 0</div>
          </div>

          <div style="margin-top:14px">
            <button class="start-btn" id="startFocusBtn"><span id="startIcon">â–¶</span> Start Focus (25:00)</button>
            <div class="preset-row">
              <div class="preset" data-min="25">25</div>
              <div class="preset" data-min="50">50</div>
              <div class="preset" data-min="15">15</div>
            </div>
          </div>

          <div class="tasks">
            <div style="display:flex;align-items:center;gap:8px;margin-top:12px">
              <input id="taskSubj" placeholder="Subject (e.g., Math)" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06)" />
              <input id="taskTime" type="time" style="padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06)" />
              <button id="addTask" style="padding:10px 12px;border-radius:10px;background:var(--accent);color:white;border:0;cursor:pointer">Add</button>
            </div>

            <div id="taskList" style="margin-top:12px">
              <!-- tasks appear here -->
            </div>
          </div>
        </div>

        <footer>No accounts. All data stays on your device.</footer>
      </div>

      <div>
        <div class="card focus-area">
          <div class="illustration" aria-hidden="true">
            <!-- simple hand-drawn desk + growing plant -->
            <svg width="320" height="140" viewBox="0 0 320 140" xmlns="http://www.w3.org/2000/svg">
              <rect x="0" y="0" width="320" height="140" fill="transparent"/>
              <g transform="translate(30,10)">
                <rect x="0" y="30" rx="10" width="180" height="80" fill="#fff" stroke="rgba(0,0,0,0.04)"/>
                <g transform="translate(200,12)">
                  <!-- plant -->
                  <g class="plant">
                    <path d="M10 80 C 30 40, 60 40, 80 80" fill="#79BFA3" stroke="rgba(0,0,0,0.06)"/>
                    <circle cx="40" cy="34" r="22" fill="#79BFA3"/>
                    <rect x="30" y="60" width="20" height="22" rx="6" fill="#8BD4B7"/>
                  </g>
                </g>
              </g>
            </svg>
          </div>

          <div class="timer-wrap">
            <div class="progress-ring" id="progressWrap">
              <div class="locked-badge" id="lockedBadge" style="display:none">Locked In</div>
              <svg width="220" height="220" viewBox="0 0 120 120">
                <defs>
                  <linearGradient id="g1" x1="0" x2="1">
                    <stop offset="0%" stop-color="#6AA6FF"/>
                    <stop offset="100%" stop-color="#61D1B6"/>
                  </linearGradient>
                </defs>
                <circle cx="60" cy="60" r="52" fill="transparent" stroke="rgba(20,30,40,0.06)" stroke-width="8"/>
                <circle id="progressCircle" cx="60" cy="60" r="52" fill="transparent" stroke="url(#g1)" stroke-width="8" stroke-dasharray="327" stroke-dashoffset="327" stroke-linecap="round" transform="rotate(-90 60 60)"></circle>
                <foreignObject x="20" y="30" width="80" height="80">
                  <div style="display:flex;align-items:center;justify-content:center" xmlns="http://www.w3.org/1999/xhtml">
                    <div class="time-label" id="timeLabel">25:00</div>
                  </div>
                </foreignObject>
              </svg>
            </div>

            <div style="display:flex;gap:8px">
              <button id="pauseBtn" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer">Pause</button>
              <button id="stopBtn" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer">Stop</button>
            </div>

            <div style="color:var(--muted);font-size:13px;margin-top:8px">Tip: Add as PWA for better alarm persistence.</div>
          </div>
        </div>

        <!-- Alarm screen -->
        <div class="alarm-screen" id="alarmScreen" role="dialog" aria-modal="true">
          <h2 id="alarmTitle">Math â€” It's time!</h2>
          <p style="color:var(--muted);max-width:360px;text-align:center">Open the app and press "I'm Ready!" to stop the alarm.</p>
          <button class="alarm-cta" id="alarmStopBtn">I'm Ready!</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Overlay: shown when user tries to exit during lock -->
  <div class="overlay" id="overlay">
    <div class="box">
      <div class="title">Stay focused!</div>
      <p>If you try to leave, your session remains locked â€” finish the time and youâ€™ll be rewarded ðŸŽ‰</p>
      <div style="margin-top:12px">
        <button id="overlayClose" style="padding:10px 12px;border-radius:10px;background:var(--accent);color:white;border:0;cursor:pointer">I will keep going</button>
      </div>
    </div>
  </div>

  <!-- confetti container -->
  <div class="confetti" id="confetti"></div>

  <!-- looping audio (you can replace src with your chime file in repo assets) -->
  <audio id="chime" loop preload="auto">
    <source src="https://cdn.jsdelivr.net/gh/harvona/harvona-assets/chime.mp3" type="audio/mpeg">
    <!-- If you host your own chime, replace the src above -->
  </audio>

  <script>
    /* ======= App State & Utilities ======= */
    const DEFAULT_MIN = 25;
    let focusMinutes = DEFAULT_MIN;
    let totalSeconds = DEFAULT_MIN*60;
    let secondsLeft = totalSeconds;
    let timerInterval = null;
    let locked = false;
    let streak = parseInt(localStorage.getItem('harvona_streak')||'0',10) || 0;

    const startBtn = document.getElementById('startFocusBtn');
    const timeLabel = document.getElementById('timeLabel');
    const progressCircle = document.getElementById('progressCircle');
    const lockedBadge = document.getElementById('lockedBadge');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const overlay = document.getElementById('overlay');
    const overlayClose = document.getElementById('overlayClose');
    const chime = document.getElementById('chime');
    const alarmScreen = document.getElementById('alarmScreen');
    const alarmStopBtn = document.getElementById('alarmStopBtn');
    const startIcon = document.getElementById('startIcon');
    const streakEl = document.getElementById('streak');

    streakEl.textContent = 'Streak: ' + (localStorage.getItem('harvona_streak')||0);

    // helpers
    function formatTime(s){
      const m = Math.floor(s/60).toString().padStart(2,'0');
      const ss = (s%60).toString().padStart(2,'0');
      return `${m}:${ss}`;
    }
    function setProgress(){
      const radius = 52;
      const full = 2*Math.PI*radius;
      const offset = full * (1 - (totalSeconds? (secondsLeft/totalSeconds) : 0));
      progressCircle.style.strokeDashoffset = Math.max(0, offset);
    }

    /* ======= Timer Controls ======= */
    function startFocus(minutes){
      if(timerInterval) return;
      focusMinutes = minutes||focusMinutes;
      totalSeconds = focusMinutes*60;
      secondsLeft = totalSeconds;
      locked = true;
      lockedBadge.style.display='inline-block';
      startIcon.textContent='â³';
      enterFullscreen().catch(()=>{/*ignore*/});
      pushLockHistory();
      saveState();
      tick(); // show initial
      timerInterval = setInterval(tick, 1000);
    }

    function tick(){
      secondsLeft--;
      if(secondsLeft < 0){
        finishFocus();
        return;
      }
      timeLabel.textContent = formatTime(secondsLeft);
      setProgress();
    }

    function pauseFocus(){
      // in our locked mode, pause should be disabled; show overlay instead
      if(locked){
        showOverlay();
        return;
      }
      if(timerInterval){ clearInterval(timerInterval); timerInterval = null; startIcon.textContent='â–¶'; }
    }

    function stopFocus(){
      if(locked){
        showOverlay();
        return;
      }
      clearInterval(timerInterval); timerInterval=null;
      secondsLeft = totalSeconds;
      timeLabel.textContent = formatTime(secondsLeft);
      progressCircle.style.strokeDashoffset = 2*Math.PI*52;
      startIcon.textContent='â–¶';
    }

    function finishFocus(){
      clearInterval(timerInterval); timerInterval = null;
      locked = false;
      lockedBadge.style.display='none';
      startIcon.textContent='âœ”';
      secondsLeft = 0;
      timeLabel.textContent = '00:00';
      setProgress();
      incrementStreak();
      showConfetti();
      exitFullscreen().catch(()=>{/*ignore*/});
      clearLockHistory();
      saveState();
      setTimeout(()=>{ startIcon.textContent='â–¶'; secondsLeft = totalSeconds; timeLabel.textContent = formatTime(secondsLeft); setProgress(); }, 1800);
    }

    function incrementStreak(){
      streak = (parseInt(localStorage.getItem('harvona_streak')||'0',10) || 0) + 1;
      localStorage.setItem('harvona_streak', streak);
      streakEl.textContent = 'Streak: ' + streak;
    }

    /* ======= Focus Lock UX tricks ======= */
    function pushLockHistory(){
      // push a history entry so the back button is trapped
      history.pushState({locked: true}, '');
      window.addEventListener('popstate', onPopState);
      window.addEventListener('beforeunload', onBeforeUnload);
    }
    function clearLockHistory(){
      // try to remove blocking events
      try{ window.removeEventListener('popstate', onPopState); window.removeEventListener('beforeunload', onBeforeUnload); }catch(e){}
    }
    function onPopState(e){
      // when back button pressed
      if(locked){
        showOverlay();
        // push state back
        history.pushState({locked:true}, '');
      }
    }
    function onBeforeUnload(e){
      if(locked){
        const msg = 'Your focus session is active. Are you sure you want to leave?';
        e.returnValue = msg;
        return msg;
      }
    }

    function showOverlay(){ overlay.classList.add('show'); }
    overlayClose.addEventListener('click', ()=> overlay.classList.remove('show'));

    /* ======= Fullscreen helpers ======= */
    async function enterFullscreen(){
      const el = document.documentElement;
      if(el.requestFullscreen) await el.requestFullscreen();
      else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
    }
    async function exitFullscreen(){
      if(document.exitFullscreen) await document.exitFullscreen();
      else if(document.webkitExitFullscreen) await document.webkitExitFullscreen();
    }

    /* ======= Confetti (simple) ======= */
    function showConfetti(){
      const container = document.getElementById('confetti');
      for(let i=0;i<70;i++){
        const el = document.createElement('div');
        el.style.position='absolute'; el.style.width='8px'; el.style.height='10px';
        el.style.left = (Math.random()*100)+'%';
        el.style.top = '-10%';
        el.style.opacity = Math.random()*0.9+0.2;
        el.style.transform = 'rotate('+ (Math.random()*360) +'deg)';
        el.style.background = ['#FFB86B','#6AA6FF','#79BFA3','#F7A58C'][Math.floor(Math.random()*4)];
        el.style.borderRadius = '2px';
        el.style.transition = 'transform 1.8s linear, top 1.8s linear';
        container.appendChild(el);
        requestAnimationFrame(()=> {
          el.style.top = (80 + Math.random()*20) + '%';
          el.style.transform = 'translateY(200px) rotate('+ (Math.random()*720) +'deg)';
        });
        setTimeout(()=> el.remove(), 2000);
      }
    }

    /* ======= Tasks & Alarms ======= */
    const taskListEl = document.getElementById('taskList');
    const subjInput = document.getElementById('taskSubj');
    const timeInput = document.getElementById('taskTime');
    const addTaskBtn = document.getElementById('addTask');

    function loadTasks(){
      const tasks = JSON.parse(localStorage.getItem('harvona_tasks')||'[]');
      return tasks;
    }
    function saveTasks(tasks){
      localStorage.setItem('harvona_tasks', JSON.stringify(tasks));
    }
    function renderTasks(){
      const tasks = loadTasks();
      taskListEl.innerHTML = '';
      tasks.forEach((t, idx) => {
        const row = document.createElement('div');
        row.className='task-row';
        const icon = document.createElement('div');
        icon.innerHTML = getEmojiForSubject(t.subject);
        icon.style.fontSize='20px';
        const subj = document.createElement('div'); subj.className='task-subject'; subj.textContent = t.subject;
        const time = document.createElement('div'); time.className='task-time'; time.textContent = t.time;
        const del = document.createElement('button'); del.textContent='âœ•'; del.style.marginLeft='8px'; del.style.border='none'; del.style.background='transparent'; del.style.cursor='pointer';
        del.addEventListener('click', ()=>{
          tasks.splice(idx,1); saveTasks(tasks); renderTasks();
        });
        row.appendChild(icon); row.appendChild(subj); row.appendChild(time); row.appendChild(del);
        taskListEl.appendChild(row);
      });
    }
    function getEmojiForSubject(s){
      const lower = (s||'').toLowerCase();
      if(lower.includes('math')) return 'ðŸ§®';
      if(lower.includes('read')||lower.includes('book')) return 'ðŸ“š';
      if(lower.includes('science')||lower.includes('chem')) return 'ðŸ§ª';
      if(lower.includes('code')||lower.includes('program')) return 'ðŸ’»';
      return 'ðŸ“˜';
    }

    addTaskBtn.addEventListener('click', ()=>{
      const subj = subjInput.value.trim(); const time = timeInput.value;
      if(!subj || !time) return alert('Add a subject and time');
      const tasks = loadTasks();
      tasks.push({subject:subj, time:time});
      saveTasks(tasks); renderTasks();
      // animation bounce on new addition:
      const last = taskListEl.lastChild;
      if(last){ last.classList.add('bounce'); setTimeout(()=>last.classList.remove('bounce'),600); }
      subjInput.value=''; timeInput.value='';
    });

    // check alarms every 10s
    setInterval(()=>{
      const tasks = loadTasks();
      const now = new Date();
      const cur = now.toTimeString().slice(0,5);
      for(const t of tasks){
        if(t.time === cur){
          // trigger alarm if not already triggered in this minute
          const key = `alarm_${t.subject}_${t.time}_${now.toDateString()}`;
          if(!localStorage.getItem(key)){
            localStorage.setItem(key, '1');
            triggerAlarm(t);
          }
        }
      }
    }, 10000);

    function triggerAlarm(task){
      // Show fullscreen alarm screen and start looping chime
      document.getElementById('alarmTitle').textContent = `${task.subject} â€” It's time!`;
      alarmScreen.classList.add('show');

      // try to play chime; requires prior user interaction in most browsers
      try{ chime.currentTime = 0; chime.play().catch(()=>{/* autoplay blocked; user must interact to hear */}); }catch(e){}
      // keep playing until user clicks "I'm Ready!"
    }
    alarmStopBtn.addEventListener('click', ()=>{
      alarmScreen.classList.remove('show');
      try{ chime.pause(); chime.currentTime=0; }catch(e){}
    });

    /* ======= Persist & restore timer state (simple) ======= */
    function saveState(){
      const state = {locked, focusMinutes, totalSeconds, secondsLeft};
      localStorage.setItem('harvona_state', JSON.stringify(state));
    }
    function restoreState(){
      try{
        const s = JSON.parse(localStorage.getItem('harvona_state')||'null');
        if(s){
          locked = s.locked; focusMinutes = s.focusMinutes; totalSeconds = s.totalSeconds; secondsLeft = s.secondsLeft;
          timeLabel.textContent = formatTime(secondsLeft || totalSeconds);
          setProgress();
          if(locked){
            lockedBadge.style.display='inline-block';
            pushLockHistory();
            // resume ticking
            timerInterval = setInterval(()=>{
              secondsLeft--;
              if(secondsLeft<0){ finishFocus(); }
              else { timeLabel.textContent=formatTime(secondsLeft); setProgress(); }
            },1000);
          }
        }
      }catch(e){}
    }

    /* ======= UI bindings ======= */
    document.querySelectorAll('.preset').forEach(el=>{
      el.addEventListener('click', ()=> {
        const m = parseInt(el.dataset.min,10) || DEFAULT_MIN;
        startFocus(m);
      });
    });

    startBtn.addEventListener('click', ()=>{
      // show a simple selector to change minutes (keep simple)
      if(!timerInterval){
        startFocus(DEFAULT_MIN);
      }
    });

    pauseBtn.addEventListener('click', pauseFocus);
    stopBtn.addEventListener('click', stopFocus);

    // allow small inline change: click timer label to change default
    timeLabel.addEventListener('click', ()=>{
      const val = prompt('Set minutes for the session (e.g., 25)', focusMinutes);
      const m = parseInt(val,10);
      if(!isNaN(m) && m>0){
        focusMinutes = m; totalSeconds = m*60; secondsLeft = totalSeconds;
        timeLabel.textContent = formatTime(secondsLeft); setProgress();
      }
    });

    // Try to grant audio permission by asking user to interact
    document.body.addEventListener('click', function ensureAudio(e){
      // we call play/pause to unlock audio on some browsers
      chime.pause();
      chime.currentTime = 0;
      document.body.removeEventListener('click', ensureAudio);
    }, {capture:true});

    // Save tasks on unload
    window.addEventListener('beforeunload', ()=> saveState());

    // Init
    renderTasks();
    restoreState();
    setProgress();

    // small UX: show overlay if user tries to switch tabs during locked session
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden && locked){
        // show overlay when they return to remind them
        localStorage.setItem('harvona_warn_hidden', '1');
      } else if(!document.hidden && locked){
        if(localStorage.getItem('harvona_warn_hidden')){
          showOverlay();
          localStorage.removeItem('harvona_warn_hidden');
        }
      }
    });

    /* ======= NOTES / Developer hints:
       - Replace the chime audio src with your own hosted file for production.
       - For alarm persistence while screen is off / app in background, convert to a PWA or wrap into a WebView app (APK) â€” then native notifications / background playback is possible.
       - This web build intentionally uses localStorage for simplicity (no server).
    ======= */
  </script>
</body>
</html>
